<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Scanner Web</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; padding: 18px; background:#f6f7fb; color:#111 }
    h1 { margin-top:0 }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
    button, select, input[type="file"] { padding:8px 10px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer }
    video, canvas { max-width:100%; border-radius:8px; background:black }
    .preview { margin-top:12px; display:flex; gap:12px; flex-direction:column; }
    .thumbs { display:flex; gap:8px; flex-wrap:wrap }
    .thumb { border:1px solid #ddd; padding:6px; background:white; border-radius:6px }
    label.small { font-size:13px; color:#444 }
  </style>
</head>
<body>
  <h1>Mini Scanner Web</h1>
  <p>Use câmera ou faça upload. Depois baixe em PNG / JPG ou gere PDF (várias páginas suportadas).</p>

  <div class="controls">
    <button id="startCam">Abrir câmera</button>
    <button id="stopCam" disabled>Parar câmera</button>
    <button id="snap" disabled>Tirar foto</button>

    <input type="file" id="fileInput" accept="image/*,application/pdf" />
    <select id="format">
      <option value="png">PNG</option>
      <option value="jpg">JPG</option>
    </select>

    <button id="downloadSingle">Baixar imagem</button>
    <button id="addPage">Adicionar ao PDF (fila)</button>
    <button id="downloadPdf">Gerar/baixar PDF</button>
  </div>

  <div>
    <video id="video" autoplay playsinline style="display:none;" width="640" height="480"></video>
    <canvas id="canvas" width="1200" height="1600" style="display:none;"></canvas>
  </div>

  <div class="preview">
    <div>
      <strong>Pré-visualização:</strong>
      <div id="previewContainer" class="thumbs"></div>
    </div>
    <div>
      <strong>Fila para o PDF:</strong>
      <div id="pdfQueue" class="thumbs"></div>
    </div>
  </div>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  (function(){
    const startCamBtn = document.getElementById('startCam');
    const stopCamBtn = document.getElementById('stopCam');
    const snapBtn = document.getElementById('snap');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const downloadSingleBtn = document.getElementById('downloadSingle');
    const formatSelect = document.getElementById('format');
    const addPageBtn = document.getElementById('addPage');
    const downloadPdfBtn = document.getElementById('downloadPdf');
    const pdfQueueEl = document.getElementById('pdfQueue');

    let stream = null;
    let lastImageDataUrl = null;
    const pdfPages = []; // array of dataURLs

    // abrir câmera
    startCamBtn.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        video.style.display = 'block';
        startCamBtn.disabled = true;
        stopCamBtn.disabled = false;
        snapBtn.disabled = false;
      } catch (err) {
        alert('Erro ao acessar a câmera: ' + err.message);
      }
    });

    stopCamBtn.addEventListener('click', () => {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.style.display = 'none';
      startCamBtn.disabled = false;
      stopCamBtn.disabled = true;
      snapBtn.disabled = true;
    });

    // tirar foto
    snapBtn.addEventListener('click', () => {
      // dimensionar canvas para resolução maior para boa qualidade no PDF
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 960;
      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      const dataURL = canvas.toDataURL('image/png');
      setPreview(dataURL);
    });

    // upload de arquivo
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      // se for imagem, ler e exibir. (PDFs podem ser tratados mais adiante).
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => setPreview(reader.result);
        reader.readAsDataURL(file);
      } else {
        alert('Suporte por enquanto: imagens. PDF upload irá extrair só a primeira página (não implementado neste exemplo).');
      }
      fileInput.value = '';
    });

    function clearPreviewsContainer() {
      previewContainer.innerHTML = '';
    }

    function setPreview(dataURL) {
      lastImageDataUrl = dataURL;
      addThumb(previewContainer, dataURL, 'preview');
    }

    function addThumb(container, dataURL, tag = '') {
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img');
      img.src = dataURL;
      img.style.maxWidth = '180px';
      img.style.height = 'auto';
      div.appendChild(img);
      if (tag === 'queue') {
        const span = document.createElement('div');
        span.className = 'small';
        span.textContent = 'Página para PDF';
        div.appendChild(span);
      } else if (tag === 'preview') {
        const span = document.createElement('div');
        span.className = 'small';
        span.textContent = 'Pré-visualização (última)';
        div.appendChild(span);
      }
      container.prepend(div);
    }

    // download single image (png or jpg)
    downloadSingleBtn.addEventListener('click', () => {
      if (!lastImageDataUrl) { alert('Tire uma foto ou faça upload primeiro.'); return; }
      const format = formatSelect.value;
      if (format === 'png') {
        downloadDataUrl(lastImageDataUrl, 'scan.png');
      } else {
        // converter para JPEG com qualidade 0.9
        convertDataURLToJpeg(lastImageDataUrl, 0.9).then(jpgDataUrl => {
          downloadDataUrl(jpgDataUrl, 'scan.jpg');
        });
      }
    });

    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function convertDataURLToJpeg(dataUrl, quality=0.92) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = img.naturalWidth;
          c.height = img.naturalHeight;
          const cc = c.getContext('2d');
          cc.drawImage(img,0,0);
          const jpg = c.toDataURL('image/jpeg', quality);
          resolve(jpg);
        };
        img.src = dataUrl;
      });
    }

    // adicionar ao PDF queue
    addPageBtn.addEventListener('click', () => {
      if (!lastImageDataUrl) { alert('Tire uma foto ou faça upload primeiro.'); return; }
      pdfPages.push(lastImageDataUrl);
      addThumb(pdfQueueEl, lastImageDataUrl, 'queue');
    });

    // gerar/baixar PDF com jsPDF
    downloadPdfBtn.addEventListener('click', async () => {
      if (pdfPages.length === 0) { alert('Fila do PDF vazia. Adicione páginas.'); return; }
      const { jsPDF } = window.jspdf;
      // A4 portrait em mm
      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });

      for (let i = 0; i < pdfPages.length; i++) {
        const dataUrl = pdfPages[i];
        // carregar imagem para obter dimensões
        const img = await loadImage(dataUrl);
        // converter pixels para mm (assume 96dpi)
        const pxToMm = (px) => px * 25.4 / 96;
        // calcular tamanho mantendo proporção para caber em A4 com margens
        const pageW = 210 - 20; // mm com margem 10mm cada lado
        const pageH = 297 - 20;
        let imgWmm = pxToMm(img.naturalWidth);
        let imgHmm = pxToMm(img.naturalHeight);
        const scale = Math.min(pageW / imgWmm, pageH / imgHmm, 1);
        imgWmm *= scale;
        imgHmm *= scale;
        const x = (210 - imgWmm) / 2;
        const y = (297 - imgHmm) / 2;
        // adicionar página
        if (i > 0) pdf.addPage();
        // jsPDF admite addImage com dataURL
        pdf.addImage(dataUrl, 'PNG', x, y, imgWmm, imgHmm);
      }
      pdf.save('scans.pdf');
    });

    function loadImage(dataUrl) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = dataUrl;
      });
    }

    // dica: ctrl+S salva a página pra testar offline
  })();
  </script>
</body>
</html>
